---
title: "Veckoschema"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

## **v23**: Introduktion till kursverktyg

Den första veckan kommer innehålla administration och avslutas med en provkörning av kursverktygen i laboration 1.

### Mål denna vecka
- Dina kurskonto på [GitHub](https://github.com/)  och [RStudio Cloud](https://rstudio.cloud/) skall vara kopplade till kursens arbetsytor.
- Första laborationen inlämnad. (Deadline söndag).

### Kursmaterial

- Hadley Wickham and Garrett Grolemund, *R for Data Science* (i fortsättningen R4DS): [Kapitel 1, Introduction](https://r4ds.had.co.nz/introduction.html).
- [Kursintroduktion (YouTube, 14:34)](https://youtu.be/gQUjg5cMUGU)
- [RStudio Cloud introduktion(YouTube, 12:52)](https://youtu.be/hsJTGkrsQkc)
- [RMarkdown introduktion (YouTube, 14:42)](https://youtu.be/Ckd3Yfkx5Hk)
- [GitHub introduktion (YouTube, 13:05)](https://youtu.be/nmxg_wthhHQ)
- [Examination och betyg (kurshemsida)](https://kurser.math.su.se/pluginfile.php/109552/mod_resource/content/1/Betygskriterier.pdf)

***

## **v24**: Enkla visualiseringar

### Mål denna vecka

- Att ha grundläggande förståelse för Rs datatyper.
- Att kunna skapa enkla diagram och förstå de grundläggande komponenterna i en `ggplot`-visualisering (`data`, `mapping`, `geom`).


### Kursmaterial

- R4DS: [Kapitel 2-4](https://r4ds.had.co.nz/introduction.html).

RStudio Primers: 

- [The Basics](https://rstudio.cloud/learn/primers/1)
- [Working with tibbles](https://rstudio.cloud/learn/primers/2.1)

### Övningar

Under rubriken övningar hittar du träningsmaterial som inte ingår i kursens examination. Detta ger bra övning inför inlämningsuppgifterna, med fördelen att du kan fråga och tipsa hur mycket du vill på kursens Discord. Skapa ett separat projekt i RStudio Cloud där du arbetar med övningar och skapa en mapp `data` i detta projekt där du kan spara de datamaterial vi använder.


Gör inte bara uppgifterna utan experimentera med data och försök hitta på egna frågeställningar att besvara, fråga på Discord om något inte blev som du tänkt. 

#### Ettor på stan

Du kan ladda ner en kopia av data från inlämningsuppgift 1 med
```{r, eval = FALSE, echo = TRUE}
download.file("https://github.com/MT3003-ST21/data/raw/main/booli_ettor_2021-05-28.csv",
              "data/booli_ettor_2021-05-28.csv")
```
och läsa in den med
```{r, eval = FALSE, echo = TRUE}
booli_ettor <- read_csv("data/booli_ettor_2021-05-28.csv")
```
Notera att det går bra att läsa direkt från en url, som i
```{r, eval = FALSE, echo = TRUE}
booli_ettor <- read_csv("https://github.com/MT3003-ST21/data/raw/main/booli_ettor_2021-05-28.csv")
```
men vi föredrar att ladda ner filen en gång, då kan vi vara säkra på att vi arbetar med samma material nästa gång vi öppnar projektet. Använd din egen fantasi för att undersöka materialet med enkla figurer, till exempel kan du undersöka

- Hur påverkar yta (`livingArea`) hyran (`rent`)?
- SVT rapporterade i våras om [rekordmånga anmälningar om lockpriser](https://www.svt.se/nyheter/inrikes/rekordmanga-anmalningar-om-lockpriser). Undersök hur förekomsten av lockpriser varierat genom att plotta  kvoten mellan slutpris och utgångspris (`soldPrice / listPrice`) mot försäljningsdatum (`soldDate`). Tips: Om figuren förstörs av ett extremt värde kan du zooma in genom att lägga till  `+ ylim(c(0, 2))` för att bestämma gränserna på `y`-axeln.
- Vilka veckodagar publicerar mäklarna sina annonser? Gör ett stapeldiagram över antalet annonser per veckodag, veckodag får du genom `weekdays(published)`.

*Faktorvariabler:* Ovanstående övning illustrerar ett vanligt problem. Veckodagarna blir sorterade i alfabetisk ordning medan vi antagligen vill ha dem i kronologisk. Problemet kommer av att en variabel av typen `character` inte innehåller någon information om kategoriernas ordning, det gör däremot en variabel av typen `factor`. För att ändra ordning behöver vi alltså göra om `weekdays(published)` till en faktorvariabel. Om vi istället för `weekdays(published)` använder `factor(weekdays(published), levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))` så ordnas staplarna i den ordning vi angett. 


#### Systembolagets katalog

Systembolaget brukade ha hela sin katalog öppen för nedladdning, [så är inte längre fallet](https://api-portal.systembolaget.se/api-update-blog/changes-in-the-api-portal) men en kopia från 2019 finns sparad i `systembolaget_2019-10-30.csv`. Ladda ner den med

```{r, eval = FALSE, echo = TRUE}
download.file("https://github.com/MT3003-ST21/data/raw/main/systembolaget_2019-10-30.csv",
              "data/systembolaget_2019-10-30.csv")
```

och läs in med

```{r, eval = FALSE, echo = TRUE}
bolaget <- read_csv("data/systembolaget_2019-10-30.csv")
```

skapa dig en överblick genom att använda t.ex. `glimpse` eller `View`. Ett enkelt sätt att få en överblick över en viss kategorisk variabel (om kategorierna inte är för många) är ett stapeldiagram med `geom_bar`, prova till exempel med variablerna `Varugrupp` eller `Ursprungsland`. Man kan koppla den kategoriska variabeln antingen till y eller x-axeln (med `aes(x = Varugrupp)` respektive `aes(y = Varugrupp)`). Vilket passar bäst?

Vilken varugrupp har högst literpris? Gör ett punktdiagram med `Varugrupp` på `y`-axeln och `PrisPerLiter` på `x`-axeln. Eftersom fördelningen för `PrisPerLiter` kan det öka läsbarheten att använda en logaritmisk skala på `x`-axeln genom att lägga till `+ scale_x_log10()` till anropet. Som med veckodagarna ovan är det inte optimalt att ordna kategorierna alfabetiskt, prova att använda `y = fct_reorder(Varugrupp, PrisPerLiter)` istället för `y = Varugrupp`. Funktionen `fct_reorder` gör om `Varugrupp` till faktorvariabel och ordnar kategorierna efter `PrisPerLiter` (medianen i varje grupp).

Med hjälp av `filter` kan vi begränsa oss till vissa kategorier (mer om detta nästa vecka). Vad genererar till exempel följande kod?
```{r, eval = FALSE, echo = TRUE}
bolaget_subdata <- filter(bolaget, 
                      Ursprunglandnamn %in% c("Sverige", "Storbritannien", "Frankrike", "Spanien"), 
                      Varugrupp %in% c("Öl", "Rött vin", "Whisky", "Aperitif och dessert"))
ggplot(data = bolaget_subdata,
       mapping = aes(y = Ursprunglandnamn)) + 
  geom_bar() + 
  facet_wrap(~Varugrupp, scales = "free_x")
```


#### Gapminder data

[Gapminder foundation](https://www.gapminder.org/) verkar för att förändra människors syn på världen med data. Titta gärna på något av [Hans Roslings föredrag](https://www.ted.com/speakers/hans_rosling?language=sv) eller använd deras [interaktiva verktyg](https://www.gapminder.org/tools/#$chart-type=bubbles&url=v1) och försök återskapa figurerna med `ggplot`. En begränsad del av deras data har sammanställts i `gapminder_2021-06-14.csv` (se [dokumentation](https://www.gapminder.org/data/documentation/)). Ladda ner med


```{r, eval = FALSE, echo = TRUE}
download.file("https://github.com/MT3003-ST21/data/raw/main/gapminder_2021-06-14.csv",
              "data/gapminder_2021-06-14.csv")
```
och läs in med
```{r, eval = FALSE, echo = TRUE}
gapminder <- read_csv("data/gapminder_2021-06-14.csv")
```



***

## **v25**: Sammanfatta en tabell


### Mål denna vecka

- Att kunna sortera och filtrera med `arrange` och `filter`.
- Skapa nya kolumner med `mutate`
- Sammanställningar med `group_by` och `summarise`

### Kursmaterial

- R4DS: [Kapitel 5-6](https://r4ds.had.co.nz/transform.html).

RStudio Primers:

- [Isolating data with dplyr](https://rstudio.cloud/learn/primers/2.2)
- [Deriving information with dplyr](https://rstudio.cloud/learn/primers/2.3)

### Övningar

#### Ettor på stan

- Använd `arrange` (eventuellt i kombination med `select` för att begränsa utskriften) för att verifiera att bostaden med äldst `constructionYear` ligger i vad som troligen är [Stockholms äldsta bevarande bostadshus](https://sv.wikipedia.org/wiki/Baggensgatan_27). För flera rader antar `constructionYear` värdet `NA`, värde saknas. Hur hanteras detta av `arrange`?

- Använd `count` och `arrange` för att hitta den gatuadress där det sålts flest ettor. Detta är [Kvinnornas hus](https://stockholmskallan.stockholm.se/post/32632) som huvudsakligen består av ettor med kokvrå.

- Inför variabeln `priceRise` som prisökningen i procent (baserat på `soldPrice` och `listPrice`) och bestäm medelvärdet av `priceRise` per mäklare (`source.name`) för alla mäklare med minst 100 försäljningar och sammanfatta med ett histogram. **OBS**: Hur hanterar funktionen `mean` saknade värden? En försäljning i materialet sticker ut, kan du hitta och filtrera bort den?

#### Gapminder data

- Gör en tabell över medelinkomsten per capita för varje kontinent 2020. Tänk på att även `income` är räknat i per capita, du behöver alltså bestämma kontinenternas totala inkomst och dela på den totala populationen.

#### Systembolagets katalog

- Illustrera hur medelpriset per liter på Röda viner beror på årgång (du kan begränsa dig till årgångar med minst 10 produkter).
- Illustrera hur medelpriset per liter på Röda viner beror på ursprungsland med ett stapeldiagram, ordna staplarna efter medelpris (du kan begränsa dig till länder med minst 10 produkter).
- Kolumnen `Alkoholhalt` är kodad som textvariabel eftersom den innehåller ett procenttecken, gör om den till numerisk genom att först ta bort procenttecknet med `str_remove` och sedan konvertera med `as.numeric`. Illustrera sedan hur pris per liter beror på alkoholhalt för varugruppen öl i ett punktdiagram med en rät trendlinje (`geom_smooth(method = "lm")`). 
- [Skattesatsen för öl](https://skatteverket.se/foretag/skatterochavdrag/punktskatter/alkoholskatt/skattesatser.4.4a47257e143e26725aecb5.html) är 2.02 kronor per liter och volymprocent, bestäm en ny variabel `SkattPerLiter` som innehåller skattesatsen. Plotta sedan `PrisPerLiter - SkattPerLiter` mot `Alkoholhalt` (för varugruppen öl) med trendlinje.


#### Badväder

Hos Havs och Vattenmyndigheten kan du hitta [statistik över vattenprover](https://havbi.havochvatten.se/analytics/saw.dll?PortalPages) tagna vid badplatser runt om i landet, ett utdrag i Excel-format kan laddas ned med 
```{r, eval = FALSE, echo = TRUE}
download.file("https://github.com/MT3003-ST21/data/raw/main/Provresultat.xlsx",
              "data/Provresultat.xlsx")
```
och läsas in med
```{r, eval = FALSE, echo = TRUE}
badvatten <- readxl::read_excel("data/Provresultat.xlsx") %>% 
  fill(Län, Kommun)
```

Vad gör funktionen `fill` i detta fall? Undersök materialet närmare avseende t.ex. skillnader mellan län, EU-bad/Övriga och Badplatstyp. En svårighet är att man för E.coli och enterokocker ibland använder ett mätvärde och ibland en övre gräns (se prefix-kolumnerna). 

***

## **v26**: Utforska data med visualiseringar

### Mål denna vecka

- Skriva en enkel rapport i Rmarkdown.
- Utforska data med `ggplot`.
- Andra laborationen inlämnad (deadline söndag).

### Kursmaterial

- R4DS: [Kapitel 7](https://r4ds.had.co.nz/exploratory-data-analysis.html), [Kapitel 27](https://r4ds.had.co.nz/r-markdown.html) och [Kapitel 28](https://r4ds.had.co.nz/graphics-for-communication.html). 


RStudio Primers:

- [Visualize Data](https://rstudio.cloud/learn/primers/3)

### Övningar

Inga speciella övningar denna vecka, experimetera med visualiseringar av data från tidigare veckor.


## **v27**: Läsa data från fil

### Mål denna vecka

- Att kunna importera tabeller från textfiler.

### Kursmaterial

- R4DS: [Kapitel 9-11](https://r4ds.had.co.nz/data-import.html).

#### Kapitel 11 från ett svenskt perspektiv

Paketet `readr` följer amerikansk standard om du inte ber det göra något annat, här listar vi några skillnader mellan svensk och amerikansk standard som kan vara bra att ha koll på.

#####  Filformatet `.csv`

`csv` står för *comma separated values* och är ett av de vanligaste formaten för att spara tabeller i en textfil. I en `csv`-fil motsvarar varje rad en rad i tabellen (översta raden består ofta av kolumnrubriker) och kommatecken används för att separera kolumner. Filen med innehåll 
```
x, y
1, 2
3, 4
```
motsvarar alltså tabellen 
```{r, echo = TRUE}
readr::read_csv(
"x, y
1, 2
3, 4")
``` 

Detta fungerar bra i engelskspråkiga länder där man använder punkt som decimaltecken. När man som i svensk standard använder kommatecken som decimaltecken används istället ofta semikolon som kolumnavgränsare. Så är till exempel fallet i Excel; om du har Excel med svenska nationella inställningar och väljer att spara en tabell i formatet `CSV (kommaavgränsad) *.csv` så sparas den i själva verket som en fil där kolumner avgränsas med semikolon. Försöker du sedan läsa in den med `read_csv` placeras alla värden i samma kolumn 
```{r, echo = TRUE}
readr::read_csv(
"x; y
1; 2
3; 4")
```
Eftersom detta är vanligt förekommande finns en specialfunktion `read_csv2` som utgår ifrån att kolumner skiljs med semikolon och komma används som decimaltecken
```{r, echo = TRUE}
readr::read_csv2(
"x; y
1; 2
3; 4")
```

##### Decimaltecken igen

När siffror kombineras med punkt, kommatecken och mellanslag gissar paketet `readr` vad dessa betyder utifrån amerikansk standard. Här kan det lätt bli fel om vi slarvar med att ange lokala inställningar (`locale`). Jämför till exempel
```{r, echo = TRUE}
readr::parse_number(c("3,14", "3 000"))
```
med
```{r, echo = TRUE}
readr::parse_number(c("3,14", "3 000"), locale = readr::locale(decimal_mark = ",", 
                                                               grouping_mark = " "))
```

Ibland får man lösa konverteringen själv. I data som matats in manuellt är det inte ovanligt att både punkt och kommatecken förekommer som decimaltecken om vartannat i samma fil. Då är det säkrare att läsa in alla kolumner som text (`chr`) och använda till exempel `str_replace(x, ",", ".")` följt av `as.numeric`.

##### Spagetti med kÃ¶ttfÃ¤rssÃ¥s

Antagligen har du någon gång stött på en text där svenska tecken bytts ut mot obegripliga symboler. Problemet beror på att det utvecklats många olika konventioner för [teckenkodning](https://sv.wikipedia.org/wiki/Teckenkod) som kan vara specifika för operativsystem och applikationer. De viktigaste att känna till är [UTF-8](https://sv.wikipedia.org/wiki/UTF-8), som är standard på webben och kan koda alla möjliga språk, och [ISO 8859-1](https://sv.wikipedia.org/wiki/ISO/IEC_8859-1) eller **latin1**, som är en enklare teckenkodning anpassad för västeropeiska språk. Paketet `readr` förutsätter alltid UTF-8, medan motsvarande funktioner i Rs `base`-paket (t.ex. `read.csv` som motsvarar `readr::read_csv`) anpassar sig efter lokala systeminställningar.

Ser ditt resutat ut som i rubriken har du antagligen försökt läsa in "köttfärssås" som latin1 när den i själva verket var kodad i UTF-8, detta är mindre vanligt med just `readr`-paketet eftersom det läser in som UTF-8 om du inte anger något annat. Om du däremot försöker läsa in en fil kodad i latin1 med `readr` blir det  `k\xf6ttf\xe4rss\xe5s` om du inte anger `locale = locale(encoding = "latin1")`.

### Övningar

#### SCB-data

I [SCBs statistikdatabas](https://www.statistikdatabasen.scb.se/pxweb/sv/ssd/) kan man skapa en länk (url) till tabeller man tagit fram. Filen på `https://www.statistikdatabasen.scb.se/sq/110431` innehåller medelålder per län i formatet *Kommaavgränsad med rubrik*. Undersök den med `read_lines("https://www.statistikdatabasen.scb.se/sq/110431")` och försök sedan läsa in den med `read_csv`.

#### Mer badvatten

Badvattenfilen som användes i tidigare övningar var exporterad som Excel-fil från [Hav och Vattenmyndigheten](https://havbi.havochvatten.se/analytics/saw.dll?PortalPages), om vi istället väljer att exportera som csv får vi en fil som kan hämtas med
```{r, eval = FALSE, echo = TRUE}
download.file("https://github.com/MT3003-ST21/data/raw/main/Provresultat_2021-06-28.csv",
              "data/Provresultat_2021-06-28.csv")
```

Försök läsa in den med `read_csv`, vad händer med vattentemperaturen? Fixa!

***

## **v28**: Omforma och sammanfläta tabeller


### Mål denna vecka

- Att kunna omforma tabeller till ett "tidy"-format.
- Att kunna skapa nya tabeller genom att sammanfoga flera tabeller med gemensamma kolumner.

### Kursmaterial (prel.)

- R4DS: [Kapitel 12-13](https://r4ds.had.co.nz/tidy-data.html)

RStudio primers:

- [Tidy your data](https://rstudio.cloud/learn/primers/4). **OBS**: I delen *Reshape Data* används funktionerna `gather` och `spread`, dessa har ersatts med `pivot_longer` och `pivot_wider` som är enklare att använda (de gamla fungerar dock fortfarande). Försök lösa övningen med `pivot_longer` och `pivot_wider`.

### Övningar

#### Gapminder data

På [gapminders dataarkiv](https://www.gapminder.org/data/) kan man ladda ner deras sammanställda datamaterial, en fil för varje variabel. Tabellen som använts i tidigare övningar är sammanställd av sådana filer. Filen med antal mobiltelefoner per land och år har vi hämtat så att den kan laddas ned med
```{r, eval = FALSE, echo = TRUE}
download.file("https://github.com/MT3003-ST21/data/raw/main/cell_phones_total_2021-06-27.csv",
              "data/cell_phones_total_2021-06-27.csv")
```
och sedan läsas in med 
```{r, eval = FALSE, echo = TRUE}
cell_phones_total <- read_csv("data/cell_phones_total_2021-06-27.csv",
                              col_types = cols(.default = "c"))
```
här ser `col_types = cols(.default = "c" )` till att alla kolumner läses in som text (`chr`) vilket kommer visa sig vara praktiskt. Du kan också prova med någon anna variabel du hämtad ned direkt från gapminder.

Uppgiften är nu att lägga till variabeln till gapminder-tabellen från tidigare övningar genom att

- Gör om `cell_phones_total` till "tidy"-format med `pivot_longer`.
- Lägg till den nya variabeln som en kolumn i gapminder tabellen med lämplig `*_join` (om du gör allt i en pipe-sekvens kan `right_join` vara lämpligt).
- Anledningen till att vi läste in alla kolumner som text är att gapminder valt att koda numeriska värden i olika enheter. Talet 1100 kodas t.ex. som `1.1k` och 12 600 000 som `12.6M`. Detta kan t.ex. lösas med `case_when` som nedan
```{r, eval = FALSE, echo = TRUE}
case_when(
  str_detect(antal_mobiler, "k") ~ 1000 * (str_remove(antal_mobiler, "k") %>% as.numeric()),
  str_detect(antal_mobiler, "M") ~ ...
```

#### Koroplet

Koropletkartor brukar användas när man vill visa hur en variabel varierar geografiskt, ofta med en indelning i områden som t.ex. län eller kommuner. Du kan ladda ner och packa upp en karta över sveriges län i som en så kallad shapefil ([hämtad från SCB](https://www.scb.se/hitta-statistik/regional-statistik-och-kartor/regionala-indelningar/digitala-granser/)) med
```{r, eval = FALSE, echo = TRUE}
download.file("https://github.com/MT3003-ST21/data/raw/main/LanSweref99TM.zip",
              "LanSweref99TM.zip")
unzip("LanSweref99TM.zip", exdir = "LanSweref99TM")
```
Paketet `sf` innehåller funktioner för att arbeta med geografiska data och kan bland annat läsa in en shapefil i tabellformat med `st_read` som sedan kan plottas med `geom_sf`
```{r, eval = FALSE, echo = TRUE}
library(sf)
karta_lan <- st_read("LanSweref99TM/Lan_Sweref99TM_region.shp", quiet = TRUE)
ggplot(karta_lan, aes(fill = LnNamn)) + geom_sf()
```

```{r, echo = FALSE, out.width = "50%"}
knitr::include_graphics("https://raw.githubusercontent.com/MT3003-ST21/mt3003-st21.github.io/main/img/lan.png")
```


Objektet `karta_lan` kan användas som en vanlig tabell/`tibble`. Det betyder att vi kan lägga till länsvisa variabler med `*_join` om vi vill färglägga efter något mer intressant än `LnNamn`. Prova tabellen med medelålder från tidigare övningar, en nyckel får du t.ex. genom att skapa en variabel `LnKod = str_sub(region, 1, 2)` i tabellen över medelålder.

Ett alternativ till `ggplot` för just kartframställning är paketet [`tmap`](https://cran.r-project.org/web/packages/tmap/vignettes/tmap-getstarted.html) som kan vara enklare att använda men mindre flexibelt.


***

## **v29**: Arbeta med text

***

## **v30**: Funktioner och iteration

***

## **v31**: APIer, databaser och webbskrap

***

## **v32**: Mer om visualisering

